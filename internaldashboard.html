<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>BuyCAN Internal Statistics Dashboard</title>
  <!-- Load Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    /* Canadian "Maple Leaf Red" as a primary accent color */
    :root {
      --canada-red: #D51900;
      --dark-red: #8B0000;
      --light-gray: #f9f9f9;
      --medium-gray: #e8e8e8;
    }

    body {
      font-family: "Arial", sans-serif;
      margin: 0;
      background-color: var(--light-gray);
      color: #333;
    }

    /* Header area with a maple leaf hint */
    .header {
      background-color: var(--canada-red);
      color: #fff;
      text-align: center;
      padding: 20px;
      margin-bottom: 20px;
    }
    .header h1 {
      margin: 0;
      font-size: 1.8rem;
      display: inline-block;
    }
    .leaf-icon {
      margin-left: 8px;
    }

    /* Container for main content */
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 20px 40px 20px;
    }

    .input-section {
      background: #fff;
      padding: 15px 20px;
      margin-bottom: 20px;
      border-radius: 5px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
      text-align: center;
    }

    .date-inputs {
      margin-bottom: 10px;
    }

    .date-inputs label {
      font-weight: bold;
      margin-right: 5px;
    }
    .date-inputs input[type="date"] {
      padding: 6px;
      width: 200px;
      border: 1px solid #ccc;
      border-radius: 4px;
      text-align: center;
    }

    .button-group {
      margin-bottom: 10px;
    }
    .button-group button {
      padding: 10px 20px;
      cursor: pointer;
      border: none;
      border-radius: 4px;
      background-color: var(--canada-red);
      color: #fff;
      font-size: 16px;
      margin: 5px;
    }
    .button-group button:hover {
      background-color: #b41500;
    }

    .error-message {
      color: red;
      font-weight: bold;
      margin-top: 10px;
    }

    /* Big bar style for views and new products */
    #big-bar {
      text-align: center;
      font-size: 1.6em;
      font-weight: bold;
      margin: 10px 0;
      color: var(--canada-red);
    }

    /* Date range styling: centered and subtle on one line */
    #date-range {
      text-align: center;
      font-size: 0.9em;
      color: #666;
      margin-top: 5px;
    }

    /* Dashboard grid: 3 cards per row */
    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 20px;
      margin-top: 20px;
    }

    .card canvas {
  max-width: 250px; /* or whatever size you prefer */
  max-height: 250px;
  margin: 0 auto;   /* centers the canvas within the card */
}


    .card {
      background: var(--medium-gray);
      border-radius: 5px;
      padding: 15px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }
    .card h3 {
      margin-top: 0;
      margin-bottom: 10px;
    }
  </style>
</head>
<body>

<!-- Header with a subtle maple leaf reference -->
<div class="header">
  <h1>BuyCAN Internal Statistics Dashboard</h1>
  <span class="leaf-icon">üçÅ</span>
</div>

<div class="container">
  <div class="input-section">
    <div class="date-inputs">
      <label for="date">Select Date:</label>
      <input type="date" id="date" />
    </div>
    <div class="button-group">
      <button id="fetchDataBtn">Fetch Stats</button>
      <button id="fetchYesterdayBtn">Fetch Yesterday's Data</button>
      <button id="fetchTodayBtn">Fetch Today's Data</button>
    </div>
    <div class="error-message" id="errorMessage"></div>
    <div>
      <p>*Data is only accurate on or after March 15th 2025</p>
    </div>
  </div>

  <!-- Big bar with Total Views and New Products, and centered date range -->
  <div class="results-section">
    <div id="big-bar">
      Total Product Views: <span id="total_views">N/A</span> | New Products Generated: <span id="new_products_generated_big">N/A</span>
    </div>
    <div id="date-range">
      From <span id="date_start">N/A</span> to <span id="date_end">N/A</span>
    </div>
  </div>

  <!-- Dashboard Grid: First row with the three pie charts; second row with two cards -->
  <div class="results-section">
    <h2>Results</h2>
    <div class="dashboard-grid">
      <!-- First Row: Three Pie Charts -->
      <div class="card">
        <h3>Scans vs Clicks</h3>
        <canvas id="pieChart"></canvas>
      </div>
      <div class="card">
        <h3>Scan Outcomes</h3>
        <canvas id="scanOutcomeChart"></canvas>
      </div>
      <div class="card">
        <h3>Product Breakdown</h3>
        <canvas id="productBreakdownChart"></canvas>
      </div>
      <!-- Second Row: Two Cards -->
      <div class="card">
        <h3>Cost Analysis</h3>
        <p><strong>Average Cost:</strong> <span id="average_cost">N/A</span></p>
        <p><strong>Max Generation Cost:</strong> <span id="max_generation_cost">N/A</span></p>
        <p><strong>Total Cost:</strong> <span id="total_cost">N/A</span></p>
      </div>
      <div class="card">
        <h3>Generation Time Analysis</h3>
        <p><strong>Average Time to Generate:</strong> <span id="average_time_to_generate">N/A</span></p>
        <p><strong>Max Generation Time:</strong> <span id="max_generation_time">N/A</span></p>
      </div>
    </div>
  </div>
</div>

<script>
  // Helper: Returns a "YYYY-MM-DD" string for a given Date, computed in EST
  function getESTDateString(date) {
    // Convert the given date to a string in the EST time zone
    const estString = date.toLocaleString('en-US', { timeZone: 'America/New_York' });
    const estDate = new Date(estString);
    const year = estDate.getFullYear();
    const month = String(estDate.getMonth() + 1).padStart(2, '0');
    const day = String(estDate.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
  }

  // Auto-populate the date input with today's date in EST
  window.addEventListener('DOMContentLoaded', function() {
    const today = new Date();
    document.getElementById('date').value = getESTDateString(today);
  });

  // Helper to format date strings to EST with AM/PM for display
  function formatESTDate(dateString) {
    const dateObj = new Date(dateString);
    return dateObj.toLocaleString('en-US', { timeZone: 'America/New_York', hour12: true });
  }

  // Global chart instances so we can update/destroy on each fetch
  let pieChartInstance, scanOutcomeChartInstance, productBreakdownChartInstance;

  function fetchData() {
    const authToken = 'PEEPEEPOOPOODOODOOKAKA';
    const dateValue = document.getElementById('date').value;
    const errorMessage = document.getElementById('errorMessage');

    // Clear any previous errors
    errorMessage.textContent = '';

    if (!dateValue) {
      errorMessage.textContent = 'Please select a date before fetching data.';
      return;
    }

    // Since the date input value is in "YYYY-MM-DD" format (representing EST),
    // we can split it to get the correct year, month, and day.
    const parts = dateValue.split("-");
    const year = parseInt(parts[0], 10);
    const month = parseInt(parts[1], 10);
    const day = parseInt(parts[2], 10);

    // Build the URL
    const url = `https://buycanadian.onrender.com/get-product-statistics?auth_token=${encodeURIComponent(authToken)}&year=${year}&month=${month}&day=${day}`;

    fetch(url)
      .then(response => {
        if (!response.ok) {
          throw new Error('Network response was not ok. Status: ' + response.status);
        }
        return response.json();
      })
      .then(data => {
        // Update Cost Analysis
        document.getElementById('average_cost').textContent = data.cost_analysis.average_cost;
        document.getElementById('max_generation_cost').textContent = data.cost_analysis.max_generation_cost;
        document.getElementById('total_cost').textContent = data.cost_analysis.total_cost;

        // Update Generation Time Analysis
        document.getElementById('average_time_to_generate').textContent = data.time_analysis.average_time_to_generate;
        document.getElementById('max_generation_time').textContent = data.time_analysis.max_generation_time;

        // Update Big Bar values: Total Views and New Products Generated
        document.getElementById('total_views').textContent = data.total_views;
        document.getElementById('new_products_generated_big').textContent = data.new_products_generated;

        // Update Date Range (converted to EST with AM/PM)
        document.getElementById('date_start').textContent = formatESTDate(data.date_range.start);
        document.getElementById('date_end').textContent = formatESTDate(data.date_range.end);

        // Create/Update Pie Chart for Scans vs Clicks
        if (pieChartInstance) {
          pieChartInstance.destroy();
        }
        pieChartInstance = new Chart(document.getElementById('pieChart'), {
          type: 'pie',
          data: {
            labels: ['Scans', 'Clicks'],
            datasets: [{
              data: [data.total_scans, data.total_clicks],
              backgroundColor: ['#D51900', '#8B0000']
            }]
          },
          options: {
            responsive: true
          }
        });

        // Create/Update Pie Chart for Scan Outcomes (Successful vs Failed Scans)
        if (scanOutcomeChartInstance) {
          scanOutcomeChartInstance.destroy();
        }
        scanOutcomeChartInstance = new Chart(document.getElementById('scanOutcomeChart'), {
          type: 'pie',
          data: {
            labels: ['Successful Scans', 'Failed Scans'],
            datasets: [{
              data: [data.total_successful_scans, data.total_failed_scans],
              backgroundColor: ['#D51900', '#8B0000']
            }]
          },
          options: {
            responsive: true
          }
        });

        // Create/Update Pie Chart for Product Breakdown
        const productsFound = data.total_successful_scans - data.new_products_generated;
        if (productBreakdownChartInstance) {
          productBreakdownChartInstance.destroy();
        }
        productBreakdownChartInstance = new Chart(document.getElementById('productBreakdownChart'), {
          type: 'pie',
          data: {
            labels: ['New Products Generated', 'Products Found in Database'],
            datasets: [{
              data: [data.new_products_generated, productsFound],
              backgroundColor: ['#D51900', '#8B0000']
            }]
          },
          options: {
            responsive: true
          }
        });
      })
      .catch(error => {
        errorMessage.textContent = 'Error fetching data: ' + error.message;
      });
  }

  // Attach event listeners to buttons
  document.getElementById('fetchDataBtn').addEventListener('click', fetchData);

  // Button to fetch yesterday's data
  document.getElementById('fetchYesterdayBtn').addEventListener('click', function() {
    const yesterday = new Date();
    yesterday.setDate(yesterday.getDate() - 1);
    document.getElementById('date').value = getESTDateString(yesterday);
    fetchData();
  });

  // Button to fetch today's data
  document.getElementById('fetchTodayBtn').addEventListener('click', function() {
    const today = new Date();
    document.getElementById('date').value = getESTDateString(today);
    fetchData();
  });
</script>

</body>
</html>
